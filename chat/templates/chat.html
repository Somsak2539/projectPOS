<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Private Chat Room</title>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; padding: 20px; }
        #chat-log { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; margin-bottom: 10px; }
        #chat-message-input { width: 80%; padding: 10px; }
        #chat-message-submit, #chat-file-submit { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; }
        .chat-message { display: flex; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; }
        .chat-bubble { padding: 10px; border-radius: 15px; max-width: 70%; word-wrap: break-word; }

        /* ‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô */
        .self { justify-content: flex-end; }
        .other { justify-content: flex-start; }
        .self .chat-bubble { background: #dcf8c6; align-self: flex-end; } /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô (LINE) */
        .other .chat-bubble { background: #ffffff; border: 1px solid #ccc; align-self: flex-start; } /* ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
    </style>
</head>
<body>


    
    <h2>Private Chat Room</h2>
    <p><strong>Room Name:</strong> <span id="room-name">{{ room_name }}</span></p>
    <p><strong>Username:</strong> <span id="username">{{ request.user.username }}</span></p>

    <div id="chat-log"></div>

    <input id="chat-message-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
    <button id="chat-message-submit">‡∏™‡πà‡∏á</button>

    <input type="file" id="chat-file-input">
    <button id="chat-file-submit">‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå</button>

    <script>
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws"; 
        const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/{{ room_name }}/`);

        chatSocket.onopen = function() {
            console.log("‚úÖ WebSocket Connected");
        };

        chatSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const chatLog = document.getElementById("chat-log");
    
            if (data.type === "chat_history") {
                chatLog.innerHTML = "";  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡πà‡∏≤
                data.messages.forEach(msg => {
                    displayMessage(msg);
                });
                scrollToBottom();  // ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡πÄ‡∏™‡∏£‡πá‡∏à
            } else {
                displayMessage(data);
                scrollToBottom();  // ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
            }
        };





        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function displayMessage(data) {
            const chatLog = document.getElementById("chat-log");
            const messageElement = document.createElement("div");
            const bubbleElement = document.createElement("div");
            
            messageElement.classList.add("chat-message");
            bubbleElement.classList.add("chat-bubble");

            if (data.sender === "{{ request.user.username }}") {
                messageElement.classList.add("self");
                bubbleElement.classList.add("self");
            } else {
                messageElement.classList.add("other");
                bubbleElement.classList.add("other");
            }

            if (data.message) {
                bubbleElement.innerHTML = `<strong>${data.sender}</strong>: ${data.message} <br><small>${data.timestamp}</small>`;
            } else if (data.file) {
                bubbleElement.innerHTML = `<strong>${data.sender}</strong>: üìé <a href="/media/chat_files/${data.file}" target="_blank">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</a> <br><small>${data.timestamp}</small>`;
            }

            messageElement.appendChild(bubbleElement);
            chatLog.appendChild(messageElement);

            // ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        document.getElementById("chat-message-submit").onclick = function() {
            const messageInput = document.getElementById("chat-message-input");
            const message = messageInput.value.trim();

            if (message === "") {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á!");
                return;
            }

            chatSocket.send(JSON.stringify({ "message": message }));
            messageInput.value = "";
        };

        document.getElementById("chat-message-input").addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                document.getElementById("chat-message-submit").click();
            }
        });

        // ‚úÖ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå
        document.getElementById("chat-file-submit").onclick = function() {
            const fileInput = document.getElementById("chat-file-input");
            const file = fileInput.files[0];

            if (!file) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á!");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64File = event.target.result.split(",")[1];
                chatSocket.send(JSON.stringify({
                    "file": base64File,
                    "filename": file.name,
                    "filetype": file.type
                }));
            };
            reader.readAsDataURL(file);
        };

        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
        window.onload = function() {
            setTimeout(() => {
                document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
            }, 200);
        };
    </script>

</body>
</html>
